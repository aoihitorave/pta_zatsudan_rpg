<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã¯ã¬ã¬ã‚“ã‚¯ã‚¨ã‚¹ãƒˆ ï½PTAãªå‹‡è€…ãŸã¡ï½</title>
<style>
    :root {
        --bg-color: #2c3e50;
        --panel-bg: #34495e;
        --text-color: #ecf0f1;
        --accent-color: #e74c3c; /* èµ¤ç³» */
        --highlight-color: #f1c40f; /* é»„è‰²ç³» */
        --btn-bg: #95a5a6;
        --btn-hover: #bdc3c7;
        --border-color: #7f8c8d;
    }
    body {
        font-family: 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 10px;
        display: flex;
        justify-content: center;
        min-height: 100vh;
    }
    #game-container {
        width: 100%;
        max-width: 850px;
        background-color: var(--panel-bg);
        border: 4px double var(--border-color);
        padding: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        display: flex;
        flex-direction: column;
        position: relative;
    }
    h1, h2, h3 { text-align: center; margin-top: 0; color: var(--highlight-color); text-shadow: 1px 1px 2px black; }
    button {
        background-color: var(--btn-bg);
        color: #2c3e50;
        border: 2px solid #fff;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        font-weight: bold;
        border-radius: 5px;
        transition: all 0.2s;
    }
    button:hover { background-color: var(--btn-hover); transform: translateY(-2px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .screen { display: none; animation: fadeIn 0.5s; }
    .active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Character Select */
    .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
    .char-card { 
        border: 2px solid var(--border-color); 
        background: rgba(0,0,0,0.2);
        padding: 10px; 
        cursor: pointer; 
        border-radius: 8px;
        transition: background 0.2s;
    }
    .char-card:hover { background: rgba(255,255,255,0.1); }
    .char-card.selected { border-color: var(--highlight-color); background-color: rgba(241, 196, 15, 0.2); }
    .char-desc { font-size: 0.85em; color: #bdc3c7; margin-top: 5px; font-style: italic; }
    
    /* Stats & Shop */
    .status-panel { display: flex; justify-content: space-around; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }
    .char-status { width: 31%; min-width: 220px; margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 5px; box-sizing: border-box;}
    .stat-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 2px; }
    .shop-item { display: flex; justify-content: space-between; border-bottom: 1px dotted #7f8c8d; padding: 8px 0; align-items: center; }

    /* Battle */
    #battle-log {
        height: 150px;
        overflow-y: scroll;
        background: rgba(0,0,0,0.4);
        border: 1px solid var(--border-color);
        padding: 10px;
        margin-bottom: 10px;
        font-size: 0.9em;
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
    }
    .log-entry { margin-bottom: 4px; border-bottom: 1px dashed #444; padding-bottom: 2px; }
    
    .enemy-display { text-align: center; margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 10px; }
    #enemy-dialogue-box {
        background: #fff;
        color: #000;
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #000;
        margin-bottom: 10px;
        font-weight: bold;
        position: relative;
        display: none;
    }
    #enemy-dialogue-box::after {
        content: "â–¼"; position: absolute; bottom: 5px; right: 10px; animation: bounce 1s infinite;
    }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(3px); } }

    .hp-bar-container { width: 100%; background: #555; height: 12px; margin-top: 2px; border-radius: 6px; overflow: hidden; }
    .hp-bar { height: 100%; background: var(--accent-color); width: 100%; transition: width 0.3s; }
    .mp-bar { height: 100%; background: #3498db; width: 100%; transition: width 0.3s; }
    
    /* Colors */
    .text-red { color: #e74c3c; }
    .text-green { color: #2ecc71; }
    .text-yellow { color: var(--highlight-color); }
    .text-blue { color: #3498db; }

    /* Modal/Overlay */
    #overlay-help {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 100;
        display: none; align-items: center; justify-content: center;
    }
    .help-content {
        background: var(--panel-bg); border: 2px solid var(--highlight-color);
        padding: 20px; max-width: 600px; max-height: 80vh; overflow-y: auto;
        border-radius: 10px;
    }
</style>
</head>
<body>

<div id="game-container">
    <div style="position: absolute; top: 10px; right: 10px;">
        <button onclick="Game.toggleHelp()" style="padding: 5px 10px; font-size:0.8em;">ï¼Ÿ ãƒ˜ãƒ«ãƒ—</button>
    </div>

    <div id="screen-title" class="screen active">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">ã¯ã¬ã¬ã‚“ã‚¯ã‚¨ã‚¹ãƒˆ</h1>
        <h2 style="font-size: 1.5em; color: #fff;">ï½ PTAãªå‹‡è€…ãŸã¡ ï½</h2>
        <p style="text-align:center; margin: 30px 0;">
            é­”ç‹ã€Œã¯ã¬ã¬ã€ç‡ã„ã‚‹PTAè»å›£ã«ç«‹ã¡å‘ã‹ãˆã€‚<br>
            èª¤è§£ã¨å’Œè§£ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£RPGã€‚
        </p>
        <div style="text-align:center;">
            <button onclick="Game.toHeroSelect()" style="font-size:1.2em; padding: 15px 40px;">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <div id="screen-select-hero" class="screen">
        <h2>ã‚ãªãŸã®åˆ†èº«ã¨ãªã‚‹ä¸»äººå…¬ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
        <div id="hero-select-grid" class="char-grid"></div>
        <div style="text-align:center; margin-top:20px;">
            <button id="hero-confirm-btn" onclick="Game.confirmHero()" disabled>ã“ã®ã‚­ãƒ£ãƒ©ã«ã™ã‚‹</button>
        </div>
    </div>

    <div id="screen-select-party" class="screen">
        <h2>å…±ã«æˆ¦ã†PTAå½¹å“¡ï¼ˆä»²é–“ï¼‰ã‚’2åé¸ã‚“ã§ãã ã•ã„</h2>
        <p id="party-count-text" style="text-align:center;">ã‚ã¨ 2 å</p>
        <div id="party-select-grid" class="char-grid"></div>
        <div style="text-align:center; margin-top:20px;">
            <button id="party-confirm-btn" onclick="Game.confirmParty()" disabled>çµæˆå®Œäº†ï¼</button>
        </div>
    </div>

    <div id="screen-hub" class="screen">
        <h3 id="floor-indicator">ç¾åœ¨åœ°: ç¬¬1éšå±¤</h3>
        <div class="status-panel" id="hub-status"></div>
        
        <div style="display:flex; gap:20px; flex-wrap:wrap;">
            <div style="flex:1; min-width:300px;">
                <h4>â–¼ å½¹å“¡ç ”ä¿® (èƒ½åŠ›å¼·åŒ–)</h4>
                <p style="font-size:0.8em;">ç²å¾—ã—ãŸçµŒé¨“å€¤(Pt)ã§èƒ½åŠ›ã‚’å¼·åŒ–ã§ãã¾ã™ã€‚<br>èƒ½åŠ›ãŒä¸ŠãŒã‚‹ã¨ã‚¹ã‚­ãƒ«ã®åŠ¹æœã‚‚ä¸Šæ˜‡ã—ã¾ã™ï¼</p>
                <div id="stat-allocation"></div>
            </div>
            <div style="flex:1; min-width:300px;">
                <h4>â–¼ ãƒã‚¶ãƒ¼ (ã‚·ãƒ§ãƒƒãƒ—) - æ‰€æŒé‡‘: <span id="gold-display">0</span>G</h4>
                <div id="shop-list"></div>
            </div>
        </div>

        <div style="text-align:center; margin-top:20px; border-top: 2px solid #555; padding-top:20px;">
            <button onclick="Game.startBattleSetup()" style="font-size:1.1em; padding:10px 30px;">>> æ¬¡ã®ä¼šè­°(éšå±¤)ã¸å‡ºå¸­ã™ã‚‹ <<</button>
        </div>
    </div>

    <div id="screen-battle" class="screen">
        <div id="enemy-dialogue-box" onclick="Battle.closeDialog()">
            <span id="enemy-dialog-text"></span>
            <br><small style="color:#888; font-weight:normal;">(ã‚¯ãƒªãƒƒã‚¯ã§æˆ¦é—˜é–‹å§‹)</small>
        </div>

        <div class="enemy-display">
            <div id="enemy-name" style="font-size:1.3em; font-weight:bold; color:#e74c3c;"></div>
            <div class="hp-bar-container" style="width:60%; margin:5px auto;"><div id="enemy-hp" class="hp-bar"></div></div>
            <div id="enemy-stats" style="font-size:0.9em;"></div>
        </div>
        
        <div class="status-panel" id="battle-status"></div>
        <div id="turn-order-display" style="text-align:center; font-size:0.8em; margin-bottom:5px; color:#f1c40f;"></div>
        <div id="battle-log"></div>
        
        <div id="command-panel" style="text-align:center; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px;">
            <h4 id="active-char-name" style="margin:5px;">--ã®ã‚¿ãƒ¼ãƒ³</h4>
            <button onclick="Battle.playerAction('attack')">æ”»æ’ƒ</button>
            <button onclick="Battle.playerAction('skill')" id="btn-skill" class="text-yellow">ã‚¹ã‚­ãƒ«</button>
            <button onclick="Battle.playerAction('focus')" class="text-blue">é›†ä¸­(MP)</button>
            <button onclick="Battle.playerAction('guard')">é˜²å¾¡</button>
        </div>
    </div>

    <div id="screen-ending" class="screen">
        <h1>MISSION COMPLETE!</h1>
        <div id="ending-text" style="white-space: pre-wrap; line-height: 1.8; padding:20px; background:rgba(255,255,255,0.1); border-radius:10px;"></div>
        <div style="text-align:center; margin-top:30px;">
            <button onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="overlay-help" onclick="Game.toggleHelp()">
        <div class="help-content" onclick="event.stopPropagation()">
            <h3>ğŸ”° PTAå‹‡è€…ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h3>
            <ul>
                <li><b>ç›®çš„:</b> å…¨10éšå±¤ã®ã€Œå›°ã£ãŸäººãŸã¡ã€ã‚’èª¬å¾—(ç‰©ç†)ã—ã€é­”ç‹ã¯ã¬ã¬ã‚’å€’ã™ã“ã¨ã€‚</li>
                <li><b>æˆé•·:</b> æ•µã‚’å€’ã™ã¨ã€Œå¼·åŒ–Ptã€ãŒè²°ãˆã¾ã™ã€‚ã€Œå½¹å“¡ç ”ä¿®ã€ã§èƒ½åŠ›ã«æŒ¯ã‚Šåˆ†ã‘ã¦ãã ã•ã„ã€‚
                    <ul>
                        <li><b>ç­‹åŠ›:</b> HPãƒ»æ”»æ’ƒãƒ»é˜²å¾¡UP (ç‰©ç†ã‚­ãƒ£ãƒ©å‘ã‘)</li>
                        <li><b>çŸ¥åŠ›:</b> MPãƒ»é­”æ³•/å›å¾©åŠ›UP (é­”æ³•ã‚­ãƒ£ãƒ©å‘ã‘)</li>
                        <li><b>æ•æ·:</b> è¡Œå‹•é †ãƒ»å›é¿ç‡UP (å…¨å“¡é‡è¦)</li>
                    </ul>
                </li>
                <li><b>ã‚¹ã‚­ãƒ«:</b> èƒ½åŠ›å€¤ãŒä¸ŠãŒã‚‹ã¨ã€ã‚¹ã‚­ãƒ«ã®å¨åŠ›ã‚„åŠ¹æœã‚‚å¼·åŠ›ã«ãªã‚Šã¾ã™ï¼</li>
                <li><b>MPç®¡ç†:</b> ã‚¹ã‚­ãƒ«ã¯å¼·åŠ›ã§ã™ãŒMPã‚’ä½¿ã„ã¾ã™ã€‚ã€Œé›†ä¸­ã€ã‚³ãƒãƒ³ãƒ‰ã‹ã€ãƒã‚¶ãƒ¼ã§å£²ã£ã¦ã„ã‚‹ã€Œé­”æ³•ã®è–æ°´ã€ã§å›å¾©ã—ã¾ã—ã‚‡ã†ã€‚</li>
                <li><b>é˜²å¾¡:</b> ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¤§ããæ¸›ã‚‰ã—ã€å°‘ã—MPã‚’å›å¾©ã—ã¾ã™ã€‚æ•µã®å¤§æŠ€ã«å‚™ãˆã¾ã—ã‚‡ã†ã€‚</li>
            </ul>
            <div style="text-align:center;"><button onclick="Game.toggleHelp()">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>
</div>

<script>
/* --- ãƒ‡ãƒ¼ã‚¿å®šç¾© --- */
const ROLES = {
    nayuta: { name: "å‹‡è€…ï¼šãªã‚†ãŸ", stats: { str: 8, int: 5, agi: 6 }, skill: "å‹‡æ°—ã®å·ä»¤", desc: "æ­£ç¾©æ„ŸãŒå¼·ã„PTAä¼šé•·å€™è£œã€‚å‘³æ–¹å…¨å“¡ã®æ”»æ’ƒåŠ›ã‚’é«˜ã‚ã‚‹ãƒãƒ•ãŒå¾—æ„ã€‚", type: "balance" },
    kakapo: { name: "é­”æ³•ä½¿ã„ï¼šã‚«ã‚«ãƒ", stats: { str: 3, int: 10, agi: 5 }, skill: "ç‚ä¸Šé­”æ³•", desc: "SNSã§ã®ç‚ä¸ŠãŒå¾—æ„ãªæƒ…å ±é€šã€‚çŸ¥åŠ›ä¾å­˜ã®è¶…å¼·åŠ›ãªæ”»æ’ƒé­”æ³•ã‚’æ”¾ã¤ã€‚", type: "magic" },
    fum:    { name: "åƒ§ä¾¶ï¼šfum", stats: { str: 4, int: 8, agi: 5 }, skill: "ç™’ã‚„ã—ã®æ ¹å›ã—", desc: "äº‹å‰ã®æ ¹å›ã—ã§ãƒˆãƒ©ãƒ–ãƒ«ã‚’æœªç„¶ã«é˜²ãã€‚å‘³æ–¹å…¨å“¡ã®HPã‚’å›å¾©ã™ã‚‹ã€‚", type: "heal" },
    yj:     { name: "ç­‹è‚‰æˆ¦å£«ï¼šYJ", stats: { str: 10, int: 2, agi: 4 }, skill: "è‚‰ä½“è¨€èª", desc: "è­°è«–ã‚ˆã‚Šç­‹è‚‰ã§è§£æ±ºã™ã‚‹ä½“è‚²ä¼šç³»ã€‚1ã‚¿ãƒ¼ãƒ³ç„¡æ•µã«ãªã‚Šç›¾ã¨ãªã‚‹ã€‚", type: "tank" },
    usan:   { name: "ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼šã†ãƒ¼ã•ã‚“", stats: { str: 5, int: 9, agi: 6 }, skill: "è«–ç†çš„ãƒãƒƒã‚¯", desc: "ç†è©°ã‚ã§ç›¸æ‰‹ã‚’è¿½ã„è¾¼ã‚€ã€‚æ•µã®æ”»æ’ƒåŠ›ã¨é˜²å¾¡åŠ›ã‚’å¤§å¹…ã«ä¸‹ã’ã‚‹ã€‚", type: "debuff" },
    akki:   { name: "ãƒãƒƒã‚¯ç”·ï¼šã‚ã£ããƒ¼", stats: { str: 6, int: 6, agi: 7 }, skill: "è³‡æœ¬æŠ•ä¸‹", desc: "å…¨ã¦ã¯ãŠé‡‘ã§è§£æ±ºã™ã‚‹ã€‚æ‰€æŒé‡‘(éƒ¨è²»)ã‚’æ¶ˆè²»ã—ã¦ç‰¹å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚", type: "gold" },
    akachan:{ name: "å¥³å„ªï¼šã‚ã‹ã¡ã‚ƒã‚“", stats: { str: 4, int: 7, agi: 8 }, skill: "æ‚²åŠ‡ã®ãƒ’ãƒ­ã‚¤ãƒ³", desc: "å˜˜æ³£ãã§æ•µã‚’å‹•æºã•ã›ã‚‹ã€‚æ•µã‚’ã€Œé­…äº†ã€ã—è¡Œå‹•ä¸èƒ½ã«ã™ã‚‹ã€‚", type: "control" },
    shira:  { name: "è‡ªç”±äººï¼šã—ã‚‰ã•ã‹", stats: { str: 6, int: 6, agi: 9 }, skill: "ã¡ã‚ƒã¶å°è¿”ã—", desc: "ä¼šè­°ã‚’ç™½ç´™ã«æˆ»ã™ã€‚ä½•ãŒèµ·ã“ã‚‹ã‹ä¸æ˜ï¼ˆå¤§å›å¾©orå¤§æ”»æ’ƒorè‡ªçˆ†ï¼‰ã€‚", type: "random" },
    nyanya: { name: "å‰µé€ è€…ï¼šã«ã‚ƒãƒ¼ã«ã‚ƒ", stats: { str: 5, int: 8, agi: 6 }, skill: "ã‚¤ãƒ™ãƒ³ãƒˆä¼ç”»", desc: "æ¥½ã—ã„ä¼ç”»ã§å£«æ°—ã‚’ä¸Šã’ã‚‹ã€‚å‘³æ–¹å…¨å“¡ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’é˜²ããƒãƒªã‚¢ä»˜ä¸ã€‚", type: "support" },
    kokona: { name: "é£Ÿã„ã—ã‚“åŠï¼šã“ã“ãª", stats: { str: 7, int: 4, agi: 6 }, skill: "å·®ã—å…¥ã‚Œå¼·å¥ª", desc: "æ•µã®HP(ãŠã‚„ã¤)ã‚’å¸åã—ã¦ã€è‡ªåˆ†ã®HPã‚’å›å¾©ã™ã‚‹ã€‚", type: "drain" }
};

const SHOP_ITEMS = [
    { name: "æ „é¤Šãƒ‰ãƒªãƒ³ã‚¯", cost: 30, type: "item", effect: "heal_hp_100", desc:"HP100å›å¾©" },
    { name: "é­”æ³•ã®è–æ°´", cost: 50, type: "item", effect: "heal_mp_50", desc:"MP50å›å¾©" },
    { name: "å®‰ç‰©ã®ãƒ¡ã‚¬ãƒ›ãƒ³", cost: 200, type: "equip", stat: "atk", val: 10, desc:"æ”»æ’ƒ+10" },
    { name: "åˆ†åšã„è³‡æ–™", cost: 200, type: "equip", stat: "matk", val: 10, desc:"é­”åŠ›+10" },
    { name: "ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œãƒãƒ‹ãƒ¥ã‚¢ãƒ«", cost: 200, type: "equip", stat: "def", val: 5, desc:"é˜²å¾¡+5" },
    { name: "è»½é‡ã‚¹ãƒ‹ãƒ¼ã‚«ãƒ¼", cost: 200, type: "equip", stat: "spd", val: 5, desc:"ç´ æ—©ã•+5" },
    { name: "ãƒ–ãƒ©ãƒ³ãƒ‰æ™‚è¨ˆ", cost: 600, type: "equip", stat: "hp", val: 150, desc:"æœ€å¤§HP+150" },
    { name: "ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç«¯æœ«", cost: 600, type: "equip", stat: "mp", val: 80, desc:"æœ€å¤§MP+80" }
];

const ENEMIES = [
    { name: "é…å¸ƒç‰©ãªãã—é­”", hp: 100, atk: 15, exp: 15, gold: 20, msg: "ã€Œãƒ—ãƒªãƒ³ãƒˆï¼Ÿã‚ãƒ¼ã€ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«ã®åº•ã§åŒ–çŸ³ã«ãªã£ã¦ã‚‹ã‹ã‚‚ï¼ã€" },
    { name: "å™‚å¥½ããƒœã‚¹ãƒãƒ", hp: 180, atk: 25, exp: 25, gold: 30, msg: "ã€Œã­ãˆèã„ãŸï¼Ÿ ã‚ã®å®¶ã®å¥¥ã•ã‚“ã€ã¾ãŸé€šè²©è²·ã£ã¦ãŸã‚ã‚ˆãƒ’ã‚½ãƒ’ã‚½â€¦ã€" },
    { name: "è«–ç ´ã—ãŸã„ãƒ‘ãƒ‘", hp: 300, atk: 40, exp: 40, gold: 50, msg: "ã€Œãã®æ„è¦‹ã®æ ¹æ‹ ã¯ï¼Ÿã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã¯ã‚ã‚‹ã‚“ã§ã™ã‹ï¼Ÿã­ãˆï¼Ÿã€" },
    { name: "è¡Œäº‹å¼·åˆ¶å‚åŠ ãŠã°ã•ã‚“", hp: 500, atk: 60, exp: 60, gold: 70, msg: "ã€Œåœ°åŸŸã¨ã®çµ†ï¼çµ†ã‚ˆï¼å…¨å“¡å‚åŠ ãŒå¸¸è­˜ã§ã—ã‚‡ï¼ï¼Ÿã€" },
    { name: "å‰ä¾‹è¸è¥²ãƒ­ãƒœãƒƒãƒˆ", hp: 800, atk: 80, exp: 90, gold: 100, msg: "ã€Œå‰ä¾‹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚å´ä¸‹ã—ã¾ã™ã€‚æ˜¨å¹´é€šã‚Šã«ã—ã¦ãã ã•ã„ã€‚ã€" },
    { name: "ITã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼é•·è€", hp: 1200, atk: 110, exp: 150, gold: 150, msg: "ã€Œãƒ¡ãƒ¼ãƒ«ã ã®ãƒ©ã‚¤ãƒ³ã ã®åˆ†ã‹ã‚‰ã‚“ï¼é€£çµ¡ç¶²ã¯é›»è©±ã§å›ã›ã¨è¨€ã£ã¦ãŠã‚‹ï¼ã€" },
    { name: "æ„è­˜é«˜ã™ããƒ—ãƒ©ãƒ³ãƒŠãƒ¼", hp: 1800, atk: 140, exp: 250, gold: 200, msg: "ã€Œã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã®KPIã¨ã‚·ãƒŠã‚¸ãƒ¼åŠ¹æœã€ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ã«å…¥ã£ã¦ã‚‹ï¼Ÿã€" },
    { name: "å››å¤©ç‹ï¼šãƒ™ãƒ«ãƒãƒ¼ã‚¯ã®å®ˆè­·è€…", hp: 2500, atk: 180, exp: 400, gold: 500, msg: "ã€Œ0.1ç‚¹ã®é‡ã¿ã‚’çŸ¥ã‚Œâ€¦ï¼åˆ‡ã‚Šæ–¹ãŒé›‘ãªã‚„ã¤ã¯è¨±ã•ã‚“ï¼ï¼ã€" },
    { name: "éŸ“å›½ãƒ‰ãƒ©ãƒå¥½ãï¼šã‚†ã†", hp: 5500, atk: 280, exp: 1000, gold: 1000, isBoss: true, skill:"ãƒã‚¿ãƒãƒ¬", msg: "ã€Œã‚ã€ãã®ãƒ‰ãƒ©ãƒï¼Ÿ ä¸»äººå…¬ã€è¨˜æ†¶å–ªå¤±ã«ãªã£ã¦å®Ÿã¯å…„å¦¹ã ã£ãŸã®ã‚ˆï½ï¼ã€" }, 
    { name: "é­”ç‹ï¼šã¯ã¬ã¬", hp: 12000, atk: 420, exp: 0, gold: 0, isBoss: true, msg: "ã€Œã‚ã‚‰ï½ã€ã‚ˆãæ¥ãŸã‚ã­ï½â™¡ ãŠèŒ¶è“å­ç”¨æ„ã—ã¦ã‚‹ã‹ã‚‰ã€ã¡ã‚‡ã£ã¨åº§ã£ã¦ããªã•ã„ã‚ˆï½ã€" }
];

/* --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ --- */
const State = {
    party: [], // { id, hp, maxHp, mp, maxMp, str, int, agi, exp, pts, eq:[] }
    gold: 200,
    floor: 1,
    heroId: null,
    selectedAllies: [],
    phase: 'title'
};

/* --- ã‚²ãƒ¼ãƒ åˆ¶å¾¡ --- */
const Game = {
    toggleHelp: () => {
        const el = document.getElementById('overlay-help');
        el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
    },
    // 1. ä¸»äººå…¬é¸æŠ
    toHeroSelect: () => {
        document.getElementById('screen-title').classList.remove('active');
        document.getElementById('screen-select-hero').classList.add('active');
        const grid = document.getElementById('hero-select-grid');
        grid.innerHTML = '';
        
        Object.keys(ROLES).forEach(key => {
            const char = ROLES[key];
            const div = document.createElement('div');
            div.className = 'char-card';
            div.innerHTML = `
                <div style="font-weight:bold; font-size:1.1em;">${char.name}</div>
                <div style="font-size:0.9em;">ç­‹:${char.stats.str} çŸ¥:${char.stats.int} æ•:${char.stats.agi}</div>
                <div style="color:var(--highlight-color); font-size:0.9em;">â˜…${char.skill}</div>
                <div class="char-desc">${char.desc}</div>
            `;
            div.onclick = () => {
                // é¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('#hero-select-grid .char-card').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                State.heroId = key;
                document.getElementById('hero-confirm-btn').disabled = false;
            };
            grid.appendChild(div);
        });
    },
    confirmHero: () => {
        document.getElementById('screen-select-hero').classList.remove('active');
        Game.toPartySelect();
    },
    // 2. ä»²é–“é¸æŠ
    toPartySelect: () => {
        document.getElementById('screen-select-party').classList.add('active');
        const grid = document.getElementById('party-select-grid');
        grid.innerHTML = '';
        State.selectedAllies = [];

        Object.keys(ROLES).forEach(key => {
            if (key === State.heroId) return; // ä¸»äººå…¬ã¯é™¤å¤–

            const char = ROLES[key];
            const div = document.createElement('div');
            div.className = 'char-card';
            div.innerHTML = `
                <div style="font-weight:bold;">${char.name}</div>
                <div style="font-size:0.8em;">ç­‹:${char.stats.str} çŸ¥:${char.stats.int} æ•:${char.stats.agi}</div>
                <div style="color:var(--highlight-color); font-size:0.8em;">â˜…${char.skill}</div>
                <div class="char-desc">${char.desc}</div>
            `;
            div.dataset.key = key;
            div.onclick = () => {
                if (State.selectedAllies.includes(key)) {
                    State.selectedAllies = State.selectedAllies.filter(k => k !== key);
                    div.classList.remove('selected');
                } else {
                    if (State.selectedAllies.length < 2) {
                        State.selectedAllies.push(key);
                        div.classList.add('selected');
                    }
                }
                
                const left = 2 - State.selectedAllies.length;
                document.getElementById('party-count-text').textContent = left === 0 ? "ãƒ¡ãƒ³ãƒãƒ¼æ±ºå®šï¼" : `ã‚ã¨ ${left} å`;
                document.getElementById('party-confirm-btn').disabled = (left !== 0);
            };
            grid.appendChild(div);
        });
    },
    confirmParty: () => {
        // ãƒ‘ãƒ¼ãƒ†ã‚£æ§‹ç¯‰
        const allIds = [State.heroId, ...State.selectedAllies];
        State.party = allIds.map(key => {
            const base = ROLES[key];
            return {
                id: key,
                name: base.name,
                baseStats: { ...base.stats },
                addStats: { str:0, int:0, agi:0 }, // å¼·åŒ–åˆ†
                skill: base.skill,
                hp: 0, maxHp: 0, mp: 0, maxMp: 0,
                atk: 0, matk:0, def: 0, spd: 0,
                pts: 3, // åˆæœŸãƒœãƒ¼ãƒŠã‚¹Pt
                buffs: {}
            };
        });
        Game.recalcStats();
        Game.fullHeal();
        
        document.getElementById('screen-select-party').classList.remove('active');
        
        // åˆå›ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
        Game.toggleHelp();
        Game.toHub();
    },
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—ï¼ˆé‡è¦ï¼šæˆé•·è¦ç´ ï¼‰
    recalcStats: () => {
        State.party.forEach(p => {
            const s = p.baseStats;
            const a = p.addStats;
            const totalStr = s.str + a.str;
            const totalInt = s.int + a.int;
            const totalAgi = s.agi + a.agi;
            
            // åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            p.maxHp = 60 + (totalStr * 18);
            p.maxMp = 30 + (totalInt * 12);
            p.atk = 15 + (totalStr * 4);     // ç‰©ç†æ”»æ’ƒåŠ›
            p.matk = 15 + (totalInt * 4);    // é­”æ³•/å›å¾©åŠ›
            p.def = Math.floor(totalStr * 1.5 + totalInt * 0.5);
            p.spd = totalAgi * 3;
            
            if(p.hp > p.maxHp) p.hp = p.maxHp;
            if(p.mp > p.maxMp) p.mp = p.maxMp;
        });
    },
    fullHeal: () => {
        State.party.forEach(p => { p.hp = p.maxHp; p.mp = p.maxMp; });
    },
    toHub: () => {
        document.getElementById('screen-battle').classList.remove('active');
        document.getElementById('screen-hub').classList.add('active');
        
        document.getElementById('floor-indicator').textContent = `ç¾åœ¨åœ°: ç¬¬${State.floor}éšå±¤ (å…¨10éšå±¤)`;
        document.getElementById('gold-display').textContent = State.gold;
        
        Game.renderHubStats();
        Game.renderShop();
    },
    renderHubStats: () => {
        const container = document.getElementById('hub-status');
        const allocContainer = document.getElementById('stat-allocation');
        container.innerHTML = '';
        allocContainer.innerHTML = '';
        
        State.party.forEach((p, idx) => {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            container.innerHTML += `
                <div class="char-status">
                    <div style="font-weight:bold; color:${['#ff8888','#88ff88','#8888ff'][idx]}">${p.name}</div>
                    <div class="stat-row"><span class="text-green">HP: ${p.hp}/${p.maxHp}</span><span class="text-blue">MP: ${p.mp}/${p.maxMp}</span></div>
                    <div class="stat-row"><span>æ”»:${p.atk} é­”:${p.matk} é˜²:${p.def} é€Ÿ:${p.spd}</span></div>
                </div>`;
            
            // å¼·åŒ–UI
            allocContainer.innerHTML += `
                <div style="margin-bottom:8px; border-bottom:1px dashed #555; padding-bottom:5px;">
                    <div style="font-weight:bold;">${p.name} (æ®‹Pt: <span class="text-yellow">${p.pts}</span>)</div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="Game.addStat(${idx}, 'str')" ${p.pts<=0?'disabled':''} style="padding:5px;">ç­‹åŠ›UP</button>
                        <button onclick="Game.addStat(${idx}, 'int')" ${p.pts<=0?'disabled':''} style="padding:5px;">çŸ¥åŠ›UP</button>
                        <button onclick="Game.addStat(${idx}, 'agi')" ${p.pts<=0?'disabled':''} style="padding:5px;">æ•æ·UP</button>
                    </div>
                </div>`;
        });
    },
    addStat: (charIdx, type) => {
        const p = State.party[charIdx];
        if (p.pts > 0) {
            p.pts--;
            p.addStats[type]++;
            Game.recalcStats();
            // æœ€å¤§å€¤ãŒå¢—ãˆãŸåˆ†ã€ç¾åœ¨å€¤ã‚‚å°‘ã—å›å¾©ã•ã›ã¦ã‚ã’ã‚‹ï¼ˆè¦ªåˆ‡è¨­è¨ˆï¼‰
            if(type==='str') p.hp += 18;
            if(type==='int') p.mp += 12;
            Game.renderHubStats();
        }
    },
    renderShop: () => {
        const list = document.getElementById('shop-list');
        list.innerHTML = '';
        SHOP_ITEMS.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'shop-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div style="font-size:0.8em; color:#bbb;">${item.desc}</div>
                </div>
                <button onclick="Game.buyItem(${idx})" ${State.gold < item.cost ? 'disabled' : ''}>${item.cost}G</button>
            `;
            list.appendChild(div);
        });
    },
    buyItem: (itemIdx) => {
        const item = SHOP_ITEMS[itemIdx];
        if (State.gold >= item.cost) {
            State.gold -= item.cost;
            document.getElementById('gold-display').textContent = State.gold;
            
            if (item.type === 'item') {
                State.party.forEach(p => {
                   if (item.effect === 'heal_hp_100') p.hp = Math.min(p.maxHp, p.hp + 100); 
                   if (item.effect === 'heal_mp_50') p.mp = Math.min(p.maxMp, p.mp + 50); 
                });
                alert("å…¨å“¡å›å¾©ã—ã¾ã—ãŸï¼");
            } else {
                // è£…å‚™ï¼ˆæ°¸ç¶šå¼·åŒ–ã¨ã—ã¦å‡¦ç†ï¼‰
                State.party.forEach(p => {
                    if (item.stat === 'atk') p.addStats.str += 2;
                    if (item.stat === 'matk') p.addStats.int += 2;
                    if (item.stat === 'def') { p.addStats.str += 1; p.addStats.int += 1; }
                    if (item.stat === 'spd') p.addStats.agi += 2;
                    if (item.stat === 'hp') p.addStats.str += 3; 
                    if (item.stat === 'mp') p.addStats.int += 3;
                });
                Game.recalcStats();
                alert(`å…¨å“¡ãŒ${item.name}ã‚’è£…å‚™ã—ã€èƒ½åŠ›ãŒå‘ä¸Šã—ã¾ã—ãŸï¼`);
            }
            Game.renderHubStats();
            Game.renderShop();
        }
    },
    startBattleSetup: () => {
        document.getElementById('screen-hub').classList.remove('active');
        document.getElementById('screen-battle').classList.add('active');
        Battle.init(State.floor);
    }
};

/* --- æˆ¦é—˜ã‚·ã‚¹ãƒ†ãƒ  --- */
const Battle = {
    turnQueue: [],
    currentEnemy: null,
    activeCharIdx: -1,
    isBattleActive: false,
    
    init: (floor) => {
        const log = document.getElementById('battle-log');
        log.innerHTML = '';
        Battle.log(`----- ç¬¬${floor}éšå±¤ ä¼šè­°é–‹å§‹ -----`);
        
        const enemyData = ENEMIES[floor - 1];
        Battle.currentEnemy = { ...enemyData, maxHp: enemyData.hp };
        
        Battle.updateEnemyDisplay();
        Battle.updatePartyDisplay();
        
        // æ•µã®ä¼šè©±ï¼ˆæˆ¦é—˜é–‹å§‹ãƒˆãƒªã‚¬ãƒ¼ï¼‰
        const dialogBox = document.getElementById('enemy-dialogue-box');
        document.getElementById('enemy-dialog-text').textContent = enemyData.msg;
        dialogBox.style.display = 'block';
        document.getElementById('command-panel').style.display = 'none';
        Battle.isBattleActive = false;
    },
    closeDialog: () => {
        if (Battle.isBattleActive) return;
        document.getElementById('enemy-dialogue-box').style.display = 'none';
        Battle.isBattleActive = true;
        Battle.startRound();
    },
    log: (msg) => {
        const el = document.getElementById('battle-log');
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = msg;
        el.prepend(div);
    },
    updateEnemyDisplay: () => {
        const e = Battle.currentEnemy;
        document.getElementById('enemy-name').textContent = e.name;
        const pct = Math.max(0, (e.hp / e.maxHp) * 100);
        document.getElementById('enemy-hp').style.width = `${pct}%`;
        document.getElementById('enemy-stats').textContent = `HP: ${e.hp} / ${e.maxHp}`;
    },
    updatePartyDisplay: () => {
        const container = document.getElementById('battle-status');
        container.innerHTML = '';
        State.party.forEach(p => {
            let statusTxt = "";
            if(p.hp <= 0) statusTxt = "<span class='text-red'>[é›¢è„±]</span>";
            else if(p.buffs['guard']) statusTxt = "<span class='text-yellow'>[é˜²å¾¡ä¸­]</span>";
            
            // è¡Œå‹•é †ãƒãƒ¼ã‚«ãƒ¼
            const isNext = Battle.turnQueue[0] === p;
            
            container.innerHTML += `
                <div class="char-status" style="border: ${isNext ? '2px solid #f1c40f' : '1px solid #555'}; opacity:${p.hp<=0?0.5:1}">
                    <div style="font-weight:bold;">${p.name} ${statusTxt}</div>
                    <div class="hp-bar-container"><div class="hp-bar" style="width:${Math.max(0,(p.hp/p.maxHp)*100)}%"></div></div>
                    <div style="font-size:0.8em; text-align:right;">${p.hp}</div>
                    <div class="hp-bar-container" style="background:#222; height:6px;"><div class="mp-bar" style="width:${Math.max(0,(p.mp/p.maxMp)*100)}%"></div></div>
                    <div style="font-size:0.8em; text-align:right; color:#3498db;">MP:${p.mp}</div>
                </div>
            `;
        });
    },
    startRound: () => {
        // ç´ æ—©ã•é †ï¼ˆãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚ã‚Šï¼‰
        let entities = [...State.party.filter(p=>p.hp>0), Battle.currentEnemy];
        entities.sort((a, b) => {
            const spdA = (a.spd || (a.isBoss ? 60 : 20)) + Math.random() * 10;
            const spdB = (b.spd || (b.isBoss ? 60 : 20)) + Math.random() * 10;
            return spdB - spdA;
        });
        
        Battle.turnQueue = entities;
        Battle.updateTurnOrder();
        Battle.nextTurn();
    },
    updateTurnOrder: () => {
        // æ•µã¯ã€ŒBOSSã€ã‹ã€Œæ•µã€ã¨è¡¨è¨˜
        const names = Battle.turnQueue.map(e => e.name === Battle.currentEnemy.name ? "ã€æ•µã€‘" : e.name.split("ï¼š")[1]).join(" â†’ ");
        document.getElementById('turn-order-display').textContent = "è¡Œå‹•é †: " + names;
    },
    nextTurn: () => {
        if (Battle.checkWinLose()) return;
        
        if (Battle.turnQueue.length === 0) {
            // ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã®å‡¦ç†ï¼ˆãƒãƒ•çµŒéãªã©ï¼‰
            Battle.startRound();
            return;
        }
        
        const actor = Battle.turnQueue.shift();
        Battle.updateTurnOrder();
        Battle.updatePartyDisplay();
        
        if (actor.hp <= 0) { 
            Battle.nextTurn();
            return;
        }

        // ãƒãƒ•è§£é™¤ï¼ˆç°¡æ˜“ï¼‰
        if (actor.buffs && actor.buffs['guard']) delete actor.buffs['guard'];

        if (actor === Battle.currentEnemy) {
            setTimeout(Battle.enemyAction, 800);
        } else {
            document.getElementById('command-panel').style.display = 'block';
            document.getElementById('active-char-name').textContent = `â˜… ${actor.name} ã®ç™ºè¨€ã‚¿ãƒ¼ãƒ³`;
            document.getElementById('btn-skill').textContent = `ã‚¹ã‚­ãƒ«: ${actor.skill} (${actor.id==='akki'?'50G':'MP15'})`;
            Battle.activeCharIdx = State.party.indexOf(actor);
        }
    },
    playerAction: (type) => {
        const actor = State.party[Battle.activeCharIdx];
        const enemy = Battle.currentEnemy;
        document.getElementById('command-panel').style.display = 'none';
        
        let msg = "";
        
        if (type === 'attack') {
            // ç‰©ç†æ”»æ’ƒï¼šç­‹åŠ›ä¾å­˜
            let dmg = Math.floor(actor.atk * (1 + Math.random()*0.2));
            if(actor.buffs['atkUp']) dmg = Math.floor(dmg * 1.5);
            // æ•µé˜²å¾¡æ¸›ç®—ï¼ˆç°¡æ˜“ï¼‰
            dmg = Math.max(1, dmg - Math.floor(State.floor * 2));
            enemy.hp -= dmg;
            msg = `${actor.name}ã®æ­£è«–ãƒ‘ãƒ³ãƒï¼ ${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;

        } else if (type === 'guard') {
            // é˜²å¾¡ï¼šãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ï¼‹MPå›å¾©
            actor.buffs['guard'] = true;
            const recMp = Math.floor(actor.maxMp * 0.1) + 5;
            actor.mp = Math.min(actor.maxMp, actor.mp + recMp);
            msg = `${actor.name}ã¯æ§˜å­è¦‹ã—ãŸã€‚ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ï¼†MP${recMp}å›å¾©ï¼`;

        } else if (type === 'focus') {
            // é›†ä¸­ï¼šMPå›å¾©ï¼ˆå¤šã‚ï¼‰
            const recMp = Math.floor(actor.maxMp * 0.3) + 10;
            actor.mp = Math.min(actor.maxMp, actor.mp + recMp);
            msg = `${actor.name}ã¯è³‡æ–™ã‚’èª­ã¿è¾¼ã‚“ã ï¼ MPãŒ${recMp}å›å¾©ã—ãŸï¼`;

        } else if (type === 'skill') {
            const cost = 15;
            if (actor.id === 'akki') { // ã‚ã£ããƒ¼ç‰¹ä¾‹
                if (State.gold < 50) { Battle.log("éƒ¨è²»(é‡‘)ãŒè¶³ã‚Šãªã„ï¼"); Battle.playerAction('attack'); return; }
            } else {
                if (actor.mp < cost) { Battle.log("MPãŒè¶³ã‚Šãªã„ï¼"); Battle.playerAction('attack'); return; }
                actor.mp -= cost;
            }
            msg = Battle.executeSkill(actor, enemy);
        }
        
        Battle.log(msg);
        Battle.updateEnemyDisplay();
        setTimeout(Battle.nextTurn, 600);
    },
    executeSkill: (actor, enemy) => {
        const id = actor.id;
        let dmg = 0;
        
        switch(id) {
            case 'nayuta': 
                 State.party.forEach(p => p.buffs['atkUp'] = true);
                 return "ã€Œã¿ã‚“ãªå”åŠ›ã—ã¦ï¼ã€å…¨å“¡ã®æ”»æ’ƒåŠ›ãŒä¸ŠãŒã£ãŸï¼";
            case 'kakapo': 
                 dmg = Math.floor(actor.matk * 3.5); // çŸ¥åŠ›ä¾å­˜
                 enemy.hp -= dmg;
                 return `å¼·çƒˆãªæ‹¡æ•£å¸Œæœ›ï¼ æ•µã«${dmg}ã®ç‚ä¸Šãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
            case 'fum': 
                 const heal = Math.floor(actor.matk * 2.5);
                 State.party.forEach(p => { if(p.hp>0) p.hp = Math.min(p.maxHp, p.hp + heal); });
                 return `æ ¹å›ã—å®Œäº†ã€‚å…¨å“¡ã®HPãŒ${heal}å›å¾©ã—ãŸï¼`;
            case 'yj': 
                 actor.buffs['invincible'] = true;
                 return "ã€Œä¿ºãŒè©±ã‚’èãï¼ã€ç­‹è‚‰ã§å…¨ã¦ã‚’å—ã‘æ­¢ã‚ã‚‹æ§‹ãˆã ï¼";
            case 'usan': 
                 enemy.atk = Math.floor(enemy.atk * 0.7);
                 return "è«–ç†çš„æ¬ é™¥ã‚’æŒ‡æ‘˜ï¼æ•µã®æ”»æ’ƒåŠ›ãŒä¸‹ãŒã£ãŸï¼";
            case 'akki': 
                 State.gold -= 50;
                 dmg = 150 + (actor.atk * 2) + (State.floor * 30); 
                 enemy.hp -= dmg;
                 return `50Gã®æ©Ÿæã‚’æŠ•å…¥ï¼ ${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼(æ®‹é‡‘:${State.gold}G)`;
            case 'akachan': 
                 enemy.stunned = true;
                 return "ã€Œã²ã©ã„â€¦ä¿¡ã˜ã¦ãŸã®ã«â€¦ã€æ•µã¯ç½ªæ‚ªæ„Ÿã§å‹•ã‘ãªã„ï¼";
            case 'shira': 
                 const r = Math.random();
                 if(r < 0.4) { dmg = actor.atk * 4; enemy.hp -= dmg; return `ã¡ã‚ƒã¶å°è¿”ã—ï¼ ã‚¯ãƒªãƒ¼ãƒ³ãƒ’ãƒƒãƒˆï¼${dmg}ãƒ€ãƒ¡ï¼`; }
                 else if(r < 0.8) { State.party.forEach(p => p.hp += 100); return "ä¼šè­°ä¸­æ­¢ï¼ã¿ã‚“ãªå…ƒæ°—ã«ãªã£ãŸï¼"; }
                 else { return "ä½•ã‚‚æ±ºã¾ã‚‰ãšä¼šè­°ãŒå»¶é•·ã—ãŸ...(åŠ¹æœãªã—)"; }
            case 'nyanya': 
                 State.party.forEach(p => p.hp += Math.floor(actor.matk)); 
                 return "æ¥½ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¼ç”»ï¼ã¿ã‚“ãªã®HPãŒä¸€æ™‚çš„ã«å¢—ãˆãŸï¼";
            case 'kokona': 
                 dmg = actor.atk + actor.matk;
                 enemy.hp -= dmg;
                 actor.hp = Math.min(actor.maxHp, actor.hp + dmg);
                 return `æ•µã®ãŠèŒ¶è“å­ã‚’å¼·å¥ªï¼${dmg}ãƒ€ãƒ¡ä¸ãˆã€è‡ªåˆ†ã‚‚å›å¾©ï¼`;
        }
    },
    enemyAction: () => {
        const enemy = Battle.currentEnemy;
        
        if (enemy.stunned) {
            Battle.log(`${enemy.name}ã¯å‹•æºã—ã¦å‹•ã‘ãªã„ï¼`);
            enemy.stunned = false;
            Battle.nextTurn();
            return;
        }

        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠ
        const targets = State.party.filter(p => p.hp > 0);
        if (targets.length === 0) return;
        const target = targets[Math.floor(Math.random() * targets.length)];
        
        let dmg = Math.max(1, enemy.atk - Math.floor(target.def/2));
        
        // ãƒœã‚¹ç‰¹æ®Šè¡Œå‹•
        if (enemy.isBoss && Math.random() < 0.3) {
             if (enemy.name.includes("ã¯ã¬ã¬")) {
                 Battle.log("ã¯ã¬ã¬ã€Œã‚ã‚‰ï½ã€ã“ã‚Œã‚ã’ã‚‹ã‚ï½ã€");
                 Battle.log("è¬ã®é£´ã¡ã‚ƒã‚“ã‚’æŠ¼ã—ä»˜ã‘ã‚‰ã‚Œã€å…¨å“¡ãŒå¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼");
                 State.party.forEach(p => { if(p.hp>0) p.hp -= Math.floor(p.maxHp * 0.3); });
             } else {
                 Battle.log("ã‚†ã†ã€Œæ¬¡å›äºˆå‘Šï¼è¡æ’ƒã®å±•é–‹ãŒâ€¦ï¼ã€");
                 Battle.log("æ°—ã«ãªã‚Šã™ãã¦å…¨å“¡ã®HPãŒæ¸›å°‘ï¼");
                 State.party.forEach(p => { if(p.hp>0) p.hp -= 40; });
             }
        } else {
            // é€šå¸¸æ”»æ’ƒ
            if (target.buffs['invincible']) {
                dmg = 0;
                Battle.log(`${target.name}ã¯ç¬‘é¡”ã§å…¨ã¦ã‚’å—ã‘æµã—ãŸï¼(ãƒ€ãƒ¡ãƒ¼ã‚¸0)`);
            } else if (target.buffs['guard']) {
                dmg = Math.floor(dmg * 0.3); // é˜²å¾¡ã§7å‰²ã‚«ãƒƒãƒˆ
                Battle.log(`${target.name}ã¯é˜²å¾¡ä¸­ï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’${dmg}ã«æŠ‘ãˆãŸï¼`);
            } else {
                target.hp -= dmg;
                Battle.log(`${enemy.name}ã®æ”»æ’ƒï¼ ${target.name}ã«${dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
            }
        }

        Battle.updatePartyDisplay();
        Battle.nextTurn();
    },
    checkWinLose: () => {
        if (Battle.currentEnemy.hp <= 0) {
            Battle.win();
            return true;
        }
        if (State.party.every(p => p.hp <= 0)) {
            Battle.lose();
            return true;
        }
        return false;
    },
    win: () => {
        Battle.updateEnemyDisplay();
        Battle.log("<span class='text-yellow'>è­°è«–çµ‚äº†(å‹åˆ©)ï¼ï¼</span>");
        
        if (State.floor === 10) {
            setTimeout(Game.showEnding, 2000);
        } else {
            const gold = Battle.currentEnemy.gold;
            const exp = Battle.currentEnemy.exp;
            State.gold += gold;
            State.party.forEach(p => { if(p.hp>0) p.pts += 4; }); // æˆé•·Pt
            
            setTimeout(() => {
                alert(`èª¬å¾—æˆåŠŸï¼\næ´»å‹•è²» ${gold}G ã‚’ç¢ºä¿ï¼\nãƒ¡ãƒ³ãƒãƒ¼ã¯çµŒé¨“ã‚’ç©ã¿ã€å¼·åŒ–Ptã‚’4ç²å¾—ã—ã¾ã—ãŸï¼`);
                State.floor++;
                Game.toHub();
            }, 1000);
        }
    },
    lose: () => {
        setTimeout(() => {
            alert("è«–ç ´ã•ã‚Œã¾ã—ãŸ(å…¨æ»…)... \nã“ã®éšå±¤ã®ä¼šè­°ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚");
            Game.fullHeal();
            Game.toHub(); 
        }, 1000);
    }
};

Game.showEnding = () => {
    document.getElementById('screen-battle').classList.remove('active');
    document.getElementById('screen-ending').classList.add('active');
    
    const text = document.getElementById('ending-text');
    text.textContent = `
    æ¿€ã—ã„è­°è«–(ãƒãƒˆãƒ«)ã®æœ«ã€ã¯ã¬ã¬ã¯å„ªé›…ã«ãƒ†ã‚£ãƒ¼ã‚«ãƒƒãƒ—ã‚’ç½®ã„ãŸã€‚
    
    ã¯ã¬ã¬ã€Œã‚ã‚‰ï½ã€ã‚ãªãŸãŸã¡å‡„ã„ã˜ã‚ƒãªã„ã®ï½ã€‚
    ã“ã‚“ãªã«ç†±å¿ƒãªäººãŸã¡ã€ä¹…ã—ã¶ã‚Šã«è¦‹ãŸã‚ï½â™¡ã€
    
    é­”ç‹ã¨æã‚Œã‚‰ã‚ŒãŸå½¼å¥³ã¯ã€å®Ÿã¯ãŸã ã®ã€Œã‚«ãƒªã‚¹ãƒã™ãã‚‹PTAä¼šé•·ã€ã ã£ãŸã®ã ã€‚
    ãã®çµ±ç‡åŠ›ã¨ç¾è²Œã€ãã—ã¦ã€Œã‚ã‚‰ï½ã€ã¨ã„ã†ç‹¬ç‰¹ã®å£èª¿ãŒã€
    å°¾ã²ã‚Œã‚’ã¤ã‘ã¦é­”ç‹ä¼èª¬ã¨ã—ã¦åºƒã¾ã£ã¦ã„ãŸã ã‘ã ã£ãŸã€‚
    
    ã¯ã¬ã¬ã€Œç§ãŒã€é­”ç‹ã€ã ãªã‚“ã¦ã€ã¿ã‚“ãªå†—è«‡ãŒä¸Šæ‰‹ãªã‚“ã ã‹ã‚‰ï½ã€‚
    ã•ã€ç¾å‘³ã—ã„ã‚±ãƒ¼ã‚­ãŒã‚ã‚‹ã®ã‚ˆã€‚é£Ÿã¹ã¦ã„ããªã•ã„ãªï½ã€
    
    ã¯ã¬ã¬ã®åº•çŸ¥ã‚Œã¬åŒ…å®¹åŠ›(ã¨é«˜ç´šãªãŠè“å­)ã®å‰ã«ã€å‹‡è€…ãŸã¡ã¯æˆ¦æ„ã‚’å–ªå¤±ã—ãŸã€‚
    
    ã“ã†ã—ã¦ã€åœ°åŸŸã®èª¤è§£ã¯è§£ã‘ã€æœ€å¼·ã®PTAãŒèª•ç”Ÿã—ãŸã®ã ã£ãŸã€‚
    
    ï½ FIN ï½
    `;
};
</script>
</body>
</html>
